<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module">
import { auth, db } from '/firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const LOGIN_URL = "/HotelA/owner_login.html";
function goLogin(){ window.location.replace(LOGIN_URL); }

onAuthStateChanged(auth, async (user) => {
  try {
    if (!user) return goLogin();

    // find restaurants owned by this user
    const q = query(collection(db, "restaurants"), where("ownerUID", "==", user.uid));
    const snap = await getDocs(q);
    if (snap.empty) return goLogin();

    const docSnap = snap.docs[0];
    const d = docSnap.data();

    // safe subscriptionEnd check (won't throw if missing)
    const end = d.subscriptionEnd?.toDate?.();
    if (d.status !== "active") return goLogin();
    if (!end || new Date() > end) return goLogin();

    // store the restaurant id for use later by the page code
    try {
      sessionStorage.setItem("restaurant_session", JSON.stringify({ rid: docSnap.id }));
      window.RESTAURANT_ID = docSnap.id;
    } catch(e) { /* ignore session errors */ }

    // allowed â€” do nothing so page continues to load
    console.log("Access granted for restaurant:", docSnap.id);
  } catch (err) {
    console.error("Guard error:", err);
    goLogin();
  }
});
</script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paiotorr â€” Owner Dashboard (Fixed Aggregation Images)</title>
<style>
/* ---------- Base ---------- */
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Arial,sans-serif;background:#fff}
body{padding:20px}

/* Disable text selection except inputs */
*:not(input):not(textarea){user-select:none;-webkit-user-select:none;-moz-user-select:none}

/* HEADER */
.headerBar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}

/* LAYOUT */
.main{display:grid;grid-template-columns:2fr 1fr;gap:16px}
.pending{border:2px solid #f1c40f;border-radius:12px;padding:14px;height:55vh;overflow-y:auto}
.right{display:grid;grid-template-rows:1fr 1fr;gap:16px;height:55vh}
.box{border-radius:12px;overflow:hidden}
.accepted{border:2px solid #2ecc71}
.rejected{border:2px solid #e74c3c}

/* TITLE + FILTER */
.titleRow{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #ddd;background:#fff}
.filterGroup{display:flex;gap:6px;align-items:center}

/* VISIBLE date display (readonly) */
.dateDisplay{
  width:120px;padding:6px;cursor:pointer;border:1px solid #ccc;border-radius:4px;background:#fff;
  user-select:none;-webkit-user-select:none;-moz-user-select:none;caret-color:transparent;
}

/* HIDDEN native date inputs */
.hiddenDate{
  position:relative;width:1px;height:1px;opacity:0;border:0;margin:0;padding:0;pointer-events:auto;
}

/* Clear button */
.clearBtn{padding:6px 10px;border:none;border-radius:6px;font-size:12px;cursor:pointer;display:none}
.accepted .clearBtn{background:#2ecc71;color:#fff}
.rejected .clearBtn{background:#e74c3c;color:#fff}

/* SCROLL AREA */
.scrollArea{padding:14px;height:calc(55vh - 52px);overflow-y:auto}
.scrollArea::after{content:"";display:block;height:220px} /* ensures last item fully visible */

/* ORDER CARD */
.order{border:2px solid #ccc;border-radius:12px;padding:12px;margin-bottom:12px}
.header{display:flex;justify-content:space-between}
.table{font-weight:bold}
.time{font-size:13px;color:#555}
.customer{font-weight:bold;margin:6px 0}
.item{display:flex;align-items:center;margin-bottom:8px}
.item img{width:70px;height:70px;border-radius:8px;margin-right:10px;object-fit:cover;border:1px solid #ccc}
.itemText{font-weight:bold}
.total{font-weight:bold;margin-top:6px}
.actions button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;margin-right:6px}
.acceptBtn{background:#2ecc71;color:#fff}
.rejectBtn{background:#e74c3c;color:#fff}

/* AGGREGATED ITEM */
.aggItem{display:flex;align-items:center;border:2px solid #000;border-radius:12px;padding:10px;margin-bottom:12px}
.aggItem img{width:70px;height:70px;border-radius:8px;margin-right:12px;object-fit:cover}

/* ANALYTICS */
.analytics{margin-top:22px;padding-top:16px;border-top:3px solid #000}
.analyticsItem{border:2px solid #000;border-radius:12px;padding:12px;margin-bottom:12px}
.bar{height:14px;border-radius:8px;background:#ddd;overflow:hidden;margin:4px 0}
.acceptBar{background:#2ecc71;height:100%}
.rejectBar{background:#e74c3c;height:100%}
.topBadge{font-size:12px;font-weight:bold;margin-left:6px}

/* responsive */
@media(max-width:1020px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<audio id="newOrderSound" preload="auto">
  <source src="https://paiotorr.com/2869-preview.mp3" type="audio/mpeg">
</audio>

<div class="headerBar">
  <h1 id="dashTitle">ðŸ“‹ Paiotorr Dashboard</h1>
</div>

<div class="main">

  <div class="pending">
    <h2>ðŸŸ¡ Pending Orders</h2>
    <div id="pending"></div>
  </div>

  <div class="right">

    <div class="box accepted">
      <div class="titleRow">
        <strong>ðŸŸ¢ Accepted</strong>
        <div class="filterGroup">
          <input id="accFromDisplay" class="dateDisplay" type="text" readonly placeholder="DDMMYY">
          <input id="accToDisplay"   class="dateDisplay" type="text" readonly placeholder="DDMMYY">
          <input id="accFrom" class="hiddenDate" type="date" />
          <input id="accTo"   class="hiddenDate" type="date" />
          <button class="clearBtn" id="accClear">Clear</button>
        </div>
      </div>
      <div class="scrollArea" id="accepted"></div>
    </div>

    <div class="box rejected">
      <div class="titleRow">
        <strong>ðŸ”´ Rejected</strong>
        <div class="filterGroup">
          <input id="rejFromDisplay" class="dateDisplay" type="text" readonly placeholder="DDMMYY">
          <input id="rejToDisplay"   class="dateDisplay" type="text" readonly placeholder="DDMMYY">
          <input id="rejFrom" class="hiddenDate" type="date" />
          <input id="rejTo"   class="hiddenDate" type="date" />
          <button class="clearBtn" id="rejClear">Clear</button>
        </div>
      </div>
      <div class="scrollArea" id="rejected"></div>
    </div>

  </div>
</div>

<div class="analytics">
  <h2>ðŸ“Š Top 3 Items</h2>
  <div id="analytics"></div>
</div>

<script type="module">
/* ---------- Firebase imports ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, onSnapshot, doc, updateDoc, Timestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ---------- Config ---------- */
const firebaseConfig = {
  apiKey:"AIzaSyDSf51jWs3I4AXX0U8M_HxKn4VtRYg72xs",
  authDomain:"hotel-order-7f1f2.firebaseapp.com",
  projectId:"hotel-order-7f1f2"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const RESTAURANT = {
  id: "hotela",
  name: "HotelA"
};

/* ---------- RESTAURANT ID LOGIC ---------- */
const manualId = RESTAURANT.id;
function getRestaurantId(){
  if(manualId) return manualId;
  try{
    const s = sessionStorage.getItem("restaurant_session");
    if(s){
      const j = JSON.parse(s);
      if(j && j.rid) return j.rid;
    }
  }catch(e){ console.error("Session error", e); }
  return "hotela";
}
const restaurantId = getRestaurantId();
document.getElementById("dashTitle").innerText = `ðŸ“‹ Paiotorr â€“ ${RESTAURANT.name}`;

/* ---------- variables & constants ---------- */
const ITEM_IMAGES = {
  "Paneer Tikka": "https://images.unsplash.com/photo-1599487488170-d11ec9c172f0?w=400",
  "Pav Bhaji": "https://paiotorr.com/image/qwdvdjnnjfgjjknfjkgnjk/cold-drink/15.54.55_53f8bc4d.jpg?w=400",
  "Chicken Curry": "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400",
  "Cold Coffee": "https://images.unsplash.com/photo-1541167760496-1628856ab772?w=400",
  "Gulab Jamun": "https://images.unsplash.com/photo-1589119908995-c6837fa14848?w=400",
  "Spring Rolls": "https://images.unsplash.com/photo-1544025162-d76694265947?w=400",
  "Coca Cola": "https://paiotorr.com/image/qwdvdjnnjfgjjknfjkgnjk/cold-drink/15.45.17_4e8d4f82.jpg?w=400",
  "Sprite": "https://paiotorr.com/image/qwdvdjnnjfgjjknfjkgnjk/cold-drink/202615.45.17_e9c762af.jpg?w=400"
};
const DEFAULT_IMG = "https://raw.githubusercontent.com/paiotorr/Paiotorr/main/image/Pizza.jpg";

/* DOM refs */
const pendingDiv = document.getElementById("pending");
const analyticsDiv = document.getElementById("analytics");
const newOrderSound = document.getElementById("newOrderSound");

/* date display wiring */
function formatDisplayDate(iso){ if(!iso) return ""; const parts=iso.split("-"); if(parts.length!==3) return iso; return `${parts[2]}/${parts[1]}/${parts[0]}`; }
function setDisplayFromHidden(hid,disp){ disp.value = hid.value ? formatDisplayDate(hid.value) : ""; }

[
  {disp:"accFromDisplay", hid:"accFrom"},
  {disp:"accToDisplay", hid:"accTo"},
  {disp:"rejFromDisplay", hid:"rejFrom"},
  {disp:"rejToDisplay", hid:"rejTo"},
].forEach(p=>{
  const disp=document.getElementById(p.disp);
  const hid=document.getElementById(p.hid);
  setDisplayFromHidden(hid,disp);
  disp.addEventListener("click",()=>{
    hid.focus();
    setTimeout(()=>{ if(hid.showPicker) try{ hid.showPicker(); }catch(e){ hid.click(); } else hid.click(); },30);
  });
  disp.addEventListener("selectstart",e=>e.preventDefault());
  hid.addEventListener("change",()=>{ setDisplayFromHidden(hid,disp); render(); });
});

/* clear buttons */
document.getElementById("accClear").addEventListener("click",()=>{ document.getElementById("accFrom").value=""; document.getElementById("accTo").value=""; document.getElementById("accFromDisplay").value=""; document.getElementById("accToDisplay").value=""; render(); });
document.getElementById("rejClear").addEventListener("click",()=>{ document.getElementById("rejFrom").value=""; document.getElementById("rejTo").value=""; document.getElementById("rejFromDisplay").value=""; document.getElementById("rejToDisplay").value=""; render(); });

/* prevent select on native date inputs */
document.querySelectorAll('input[type="date"]').forEach(input=>input.addEventListener("selectstart",e=>e.preventDefault()));

/* ---------- orders snapshot & strict timestamp handling ---------- */
let firstLoad = true;
let allOrders = [];
const soundedOrderIds = new Set();

/*
  createdNowIds tracks documents for which we just set createdAt (server-side)
  during this snapshot handling. This allows the UI to treat those docs as having a
  permanent creation timestamp from this moment forward (and ensures proper ordering).
*/
let createdNowIds = new Set();

onSnapshot(collection(db,"restaurants",restaurantId,"orders"), snap=>{
  let playSound = false;
  let scrollAcc = false;
  let scrollRej = false;
  createdNowIds.clear();

  // 1) If an added document lacks createdAt, set it ONCE (server Timestamp).
  //    This ensures every order gets one permanent createdAt value at the moment
  //    it is first observed in the system.
  snap.docChanges().forEach(change=>{
    const docData = change.doc.data();
    // If newly added and has no createdAt, set it once.
    if(change.type === "added" && !docData.createdAt){
      const ref = doc(db,"restaurants",restaurantId,"orders", change.doc.id);
      // set server timestamp for createdAt; do not overwrite if it exists.
      updateDoc(ref, { createdAt: Timestamp.now() }).catch(()=>{ /* ignore failures */ });
      createdNowIds.add(change.doc.id);
    }

    // sound detection: only play sound for newly added pending orders after initial load
    if(change.type === "added" && docData.status === "pending" && !firstLoad){
      const id = change.doc.id;
      if(!soundedOrderIds.has(id)){
        soundedOrderIds.add(id);
        playSound = true;
      }
    }

    // detect if a doc changed to accepted/rejected to allow scrolling accepted/rejected to top
    if((change.type === "added" || change.type === "modified") && !firstLoad){
      const newStatus = change.doc.data()?.status;
      if(newStatus === "accepted") scrollAcc = true;
      if(newStatus === "rejected") scrollRej = true;
    }
  });

  // 2) Build in-memory list using the authoritative createdAt when present.
  const orders = [];
  snap.forEach(d=>{
    const o = d.data();
    // Prefer Firestore server Timestamp (o.createdAt) -> convert to Date()
    let createdAt;
    if(o.createdAt && typeof o.createdAt.toDate === "function"){
      createdAt = o.createdAt.toDate();
    } else if(createdNowIds.has(d.id)){
      // We just set server Timestamp above â€” but it may not be present yet in this snapshot.
      // Use current client time as the local representation; the server timestamp will be permanent.
      createdAt = new Date();
    } else {
      // If createdAt is truly missing (rare), assign epoch 0 so it sorts last and later
      // the createdAt will be set when the doc is observed in future snapshots.
      createdAt = new Date(0);
    }
    orders.push({ id: d.id, ...o, createdAt });
  });

  // 3) Play sound if needed
  if(playSound){
    newOrderSound.currentTime = 0;
    newOrderSound.play().catch(()=>{});
  }

  firstLoad = false;

  // 4) Sort entire collection by createdAt descending (newest first).
  //    This single rule guarantees newest is always on top in Pending/Accepted/Rejected.
  orders.sort((a,b)=> b.createdAt - a.createdAt);
  allOrders = orders;
  render();

  // 5) Scroll accepted/rejected/pending containers to top when a new item arrives there (visual real-time effect).
  if(playSound && pendingDiv.parentElement){
    pendingDiv.parentElement.scrollTop = 0;
  }
  if(scrollAcc){
    const el = document.getElementById("accepted");
    if(el) el.scrollTop = 0;
  }
  if(scrollRej){
    const el = document.getElementById("rejected");
    if(el) el.scrollTop = 0;
  }
});

/* ---------- render logic (consistent with ordering rules) ---------- */
function render(){
  renderPending();
  renderBox("accepted", document.getElementById("accFrom"), document.getElementById("accTo"), document.getElementById("accClear"));
  renderBox("rejected", document.getElementById("rejFrom"), document.getElementById("rejTo"), document.getElementById("rejClear"));
  renderAnalytics();
}

function renderPending(){
  pendingDiv.innerHTML = "";
  // list already sorted by createdAt desc
  const list = allOrders.filter(o=>o.status==="pending");
  list.forEach(o => renderSingleOrder(o, pendingDiv, true));
}

function renderBox(status, from, to, clearBtn){
  let list = allOrders.filter(o=>o.status===status);
  const container = document.getElementById(status);
  container.innerHTML = "";

  if(from.value && to.value){
    clearBtn.style.display = "inline-block";
    const f = new Date(from.value);
    const t = new Date(to.value); t.setHours(23,59,59,999);
    list = list.filter(o=>o.createdAt >= f && o.createdAt <= t);
    renderAggregated(list, container, status);
  } else {
    clearBtn.style.display = "none";
    list.forEach(o=>renderSingleOrder(o,container,false));
  }
}

function renderSingleOrder(o, container, actions){
  // Ensure newest stays on top by appending in the already-sorted order.
  // (allOrders is sorted descending)
  let items = "";
  (o.items||[]).forEach(i=>{
    const img = i.img || ITEM_IMAGES[i.name] || DEFAULT_IMG;
    // add onerror fallback so broken/missing URLs show DEFAULT_IMG
    items += `<div class="item"><img src="${img}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'"><div class="itemText">${escapeHtml(i.name)} Ã— ${i.qty}</div></div>`;
  });

  // Format timestamp consistently; this display never mutates the stored createdAt.
  const timeText = o.createdAt && o.createdAt.getTime() !== 0 ? o.createdAt.toLocaleString() : "â€”";

  const html = `
    <div class="order" data-id="${o.id}">
      <div class="header"><div class="table">Table ${escapeHtml(String(o.table||"â€”"))}</div><div class="time">${escapeHtml(timeText)}</div></div>
      <div class="customer">ðŸ‘¤ ${escapeHtml(o.customer||"â€”")}</div>
      ${items}
      <div class="total">â‚¹${escapeHtml(String(o.total||0))}</div>
      ${actions?`<div class="actions"><button class="acceptBtn" onclick="setStatus('${o.id}','accepted')">Accept</button><button class="rejectBtn" onclick="setStatus('${o.id}','rejected')">Reject</button></div>`:""}
    </div>`;

  container.insertAdjacentHTML("beforeend", html);
}

function renderAggregated(list, container, status){
  const map = {};

  // Build aggregate map (qty + image fallback)
  list.forEach(o=> (o.items||[]).forEach(i=>{
    if(!map[i.name]) map[i.name] = { qty:0, img: i.img || ITEM_IMAGES[i.name] || DEFAULT_IMG };
    map[i.name].qty += i.qty;
  }));

  // Convert map to array and sort by quantity descending (highest first).
  const sortedItems = Object.entries(map)
    .map(([name,data]) => ({ name, qty: data.qty, img: data.img || DEFAULT_IMG }))
    .sort((a,b) => b.qty - a.qty); // deterministic: high -> low

  container.innerHTML = "";

  sortedItems.forEach(item=>{
    // ensure image fallback via onerror attribute (in case the chosen URL fails)
    container.insertAdjacentHTML("beforeend",`
      <div class="aggItem">
        <img src="${item.img}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'">
        <div><b>${escapeHtml(item.name)}</b><br>${status==="accepted"?"Accepted":"Rejected"}: ${item.qty}</div>
      </div>
    `);
  });
}

function renderAnalytics(){
  const stats = {};
  allOrders.forEach(o=> (o.items||[]).forEach(i=>{
    if(!stats[i.name]) stats[i.name] = { total:0, accepted:0, rejected:0 };
    stats[i.name].total += i.qty;
    if(o.status==="accepted") stats[i.name].accepted += i.qty;
    if(o.status==="rejected") stats[i.name].rejected += i.qty;
  }));
  analyticsDiv.innerHTML = "";
  Object.entries(stats).sort((a,b)=>b[1].total - a[1].total).slice(0,3).forEach(([name,data],i)=>{
    const accP = data.total ? Math.round(data.accepted/data.total*100) : 0;
    const rejP = data.total ? Math.round(data.rejected/data.total*100) : 0;
    analyticsDiv.insertAdjacentHTML("beforeend",`
      <div class="analyticsItem">
        <b>${escapeHtml(name)}</b>
        <span class="topBadge">Top ${i+1}</span>
        <div>Total Orders: <b>${data.total}</b></div>
        <div>Accepted: ${data.accepted} (${accP}%)</div><div class="bar"><div class="acceptBar" style="width:${accP}%"></div></div>
        <div>Rejected: ${data.rejected} (${rejP}%)</div><div class="bar"><div class="rejectBar" style="width:${rejP}%"></div></div>
      </div>
    `);
  });
}

/* ---------- update status (DO NOT overwrite createdAt) ---------- */
window.setStatus = async (id, status) => {
  // IMPORTANT: Only update the status field. Never modify createdAt.
  try {
    await updateDoc(doc(db,"restaurants",restaurantId,"orders",id), { status });
    // The onSnapshot listener will pick up the change and re-render; createdAt remains unchanged.
  } catch(e){
    console.error("Failed to update status", e);
  }
};

/* helper */
function escapeHtml(s){ return s ? String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) : ""; }

/* security & accessibility helpers */
document.addEventListener('contextmenu', e=>e.preventDefault());
document.addEventListener('keydown', e=>{
  const forbidden = ['c','v','x','u','s'];
  if((e.ctrlKey || e.metaKey) && forbidden.includes(e.key.toLowerCase())) e.preventDefault();
  if(e.key === "F12") e.preventDefault();
});
</script>
<footer style="margin-top:40px;text-align:center;font-size:13px;color:#555;">
  Â© 2026 Paiotorr. All Rights Reserved.
</footer>
</body>
  <button id="logoutBtn" style="position:fixed;right:16px;top:16px;">Logout</button>
<script type="module">
import { auth } from '/firebase.js';
import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await signOut(auth);
  sessionStorage.removeItem('restaurant_session');
  window.location.href = "/HotelA/owner_login.html";
});
</script>

</script>

<!-- ðŸšª LOGOUT BUTTON (YOU CAN MOVE THIS ANYWHERE IN YOUR UI) -->
<button onclick="logout()">Logout</button>
</html>
