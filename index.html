<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1280, initial-scale=0.3, maximum-scale=1.0, user-scalable=no">
<title>PAIOTORR - The Rajdhani Eatery</title>

<style>
/* --- BASE STYLES --- */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  scroll-behavior: smooth;
  background: #f8f8f8;
  font-family: Arial, sans-serif;
  min-width: 1280px; 
  overflow-x: hidden;
}

h1 { text-align: center; font-size: 48px; margin-top: 30px; }
#tableInfo { text-align: center; font-weight: bold; font-size: 30px; color: #555; }

#mainMenuContainer {
  padding-bottom: 1500px; 
}

/* --- CATEGORY HEADERS --- */
.category-header {
  display: flex;
  align-items: center;
  text-align: center;
  font-size: 42px;
  font-weight: 900;
  color: #000;
  margin: 80px 0 40px 0;
  text-transform: uppercase;
  padding: 15px;
}
.category-header::before, .category-header::after {
  content: "";
  flex: 1;
  border-bottom: 6px solid #000;
}
.category-header::before { margin-right: 30px; }
.category-header::after { margin-left: 30px; }

@keyframes redFlash {
  0% { background-color: transparent; color: #000; }
  50% { background-color: #e74c3c; color: #fff; }
  100% { background-color: transparent; color: #000; }
}
.header-flash-red { animation: redFlash 1.2s ease-in-out; }

/* --- MENU ITEMS --- */
.menu { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; padding: 0 40px; }
.item { background: #fff; border: 2px solid #ddd; width: 300px; padding: 25px; text-align: center; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
.item img { width: 100%; height: 240px; object-fit: cover; border-radius: 16px; }
.item h3 { font-size: 32px; margin: 15px 0; }
.item p { font-size: 28px; color: #27ae60; font-weight: bold; margin-bottom: 20px; }

.add-btn { 
  width: 100%; padding: 20px; font-size: 26px; font-weight: bold; 
  background: #3498db; color: #fff; border: none; border-radius: 16px; 
  cursor: pointer;
}

@keyframes buttonFlash {
  0% { background-color: #3498db; transform: scale(1); }
  50% { background-color: #2ecc71; transform: scale(1.1); }
  100% { background-color: #3498db; transform: scale(1); }
}
.btn-highlight { animation: buttonFlash 0.4s ease-out; }

/* --- BOTTOM ORDER PANEL --- */
#orderBox {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  border-top: 6px solid #27ae60;
  z-index: 9999;
  box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
  overscroll-behavior: contain;
}

#orderInner { max-width: 1100px; margin: auto; padding: 25px; box-sizing: border-box; }

#categoryNavigationBox {
  border: 3px solid #000;
  border-radius: 15px;
  padding: 12px;
  margin-bottom: 20px;
  overflow: hidden;
  position: relative;
}

#catBar {
  display: flex;
  overflow-x: auto;
  white-space: nowrap;
  gap: 20px;
  padding: 10px;
  scrollbar-width: none;
  touch-action: pan-x; 
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
#catBar::-webkit-scrollbar { display: none; }

.cat-btn {
  flex: 0 0 auto;
  padding: 18px 50px;
  font-size: 24px;
  font-weight: bold;
  border: 4px solid transparent;
  border-radius: 60px;
  color: white;
  cursor: pointer;
}
/* Colors */
.cat-veg { background: #27ae60 !important; }
.cat-non-veg { background: #e74c3c !important; }
.cat-drinks { background: #2980b9 !important; }
.cat-starters { background: #f39c12 !important; }
.cat-desserts { background: #9b59b6 !important; }
.cat-active { border-color: #000 !important; transform: scale(1.05); }

#customerName {
  width: 100%; padding: 22px; font-size: 30px; font-weight: 900;
  margin-bottom: 20px; border: 3px solid #ddd; border-radius: 15px;
  box-sizing: border-box;
}

#orderList {
  max-height: 440px; 
  overflow-y: auto;
  margin-bottom: 15px;
  touch-action: pan-y;
  overscroll-behavior: contain;
}

.order-item { 
  display: flex; justify-content: space-between; align-items: center; 
  margin-bottom: 12px; padding: 20px; background: #f1f1f1; 
  border-radius: 16px; height: 70px; 
}

.order-name { font-size: 28px; font-weight: 800; }
.remove-btn { width: 60px; height: 60px; border-radius: 50%; font-size: 30px; border: none; background: #e74c3c; color: #fff; }
#totalPrice { text-align: center; font-size: 34px; font-weight: 900; margin-bottom: 15px; }
.submit-btn { width: 100%; padding: 30px; font-size: 32px; font-weight: bold; background: #27ae60; color: #fff; border: none; border-radius: 25px; cursor: pointer; }

/* POPUP */
#popup { position: fixed; inset: 0; background: rgba(0,0,0,.85); display: none; align-items: center; justify-content: center; z-index: 10000; }
.popup-box { background: #fff; width: 550px; padding: 60px; text-align: center; border-radius: 35px; position: relative; }
</style>
</head>

<body>

<h1>PAIOTORR - The Rajdhani Eatery</h1>
<p id="tableInfo"></p>

<div id="mainMenuContainer"></div>

<div id="orderBox">
  <div id="orderInner">
    <div id="categoryNavigationBox">
      <div id="catBar"></div>
    </div>
    <input id="customerName" placeholder="Enter your name">
    <div id="orderList"></div>
    <div id="totalPrice"></div>
    <button class="submit-btn" onclick="submitOrder()">ðŸ›Ž SUBMIT ORDER</button>
  </div>
</div>

<div id="popup">
  <div class="popup-box">
    <div id="closeBtn" style="position:absolute;top:20px;right:25px;font-size:45px;cursor:pointer;color:#e74c3c" onclick="manualClose()">âœ–</div>
    <div id="popupIcon" style="font-size:130px"></div>
    <div id="popupText" style="font-size:36px;font-weight:bold;margin-top:20px"></div>
    <div id="popupPrice" style="font-size:34px;font-weight:900;margin-top:15px"></div>
  </div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {getFirestore,collection,addDoc,doc,onSnapshot,updateDoc} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app=initializeApp({
 apiKey:"AIzaSyDSf51jWs3I4AXX0U8M_HxKn4VtRYg72xs",
 authDomain:"hotel-order-7f1f2.firebaseapp.com",
 projectId:"hotel-order-7f1f2"
});
const db=getFirestore(app);

const table=new URLSearchParams(location.search).get("table")||"1";
tableInfo.innerText="Table: "+table;

const menuData = [
  { name: "Paneer Tikka", price: 180, category: "Starters", img: "https://images.unsplash.com/photo-1599487488170-d11ec9c172f0?w=400" },
  { name: "Veg Pizza", price: 199, category: "Veg", img: "https://raw.githubusercontent.com/paiotorr/Paiotorr/main/image/Pizza.jpg" },
  { name: "Chicken Curry", price: 280, category: "Non-Veg", img: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400" },
  { name: "Cold Coffee", price: 90, category: "Drinks", img: "https://images.unsplash.com/photo-1541167760496-1628856ab772?w=400" },
  { name: "Gulab Jamun", price: 60, category: "Desserts", img: "https://images.unsplash.com/photo-1589119908995-c6837fa14848?w=400" },
  { name: "Spring Rolls", price: 120, category: "Starters", img: "https://images.unsplash.com/photo-1544025162-d76694265947?w=400" }
];

const POPUP_KEY=`popup_${table}`, ORDER_KEY=`order_${table}`, DISMISSED_KEY=`popup_dismissed_${table}`;
let order={}, total=0;

// --- TIME CONSTANTS (Milliseconds) ---
const TIME_SUBMITTED = 8 * 60 * 1000; // 8 Minutes
const TIME_RESULT = 5 * 60 * 1000;    // 5 Minutes

// --- SMART SCROLL GUARD ---
const orderBox = document.getElementById("orderBox");
const orderList = document.getElementById("orderList");
const catBar = document.getElementById("catBar");

orderBox.addEventListener('touchmove', (e) => {
    const isScrollable = orderList.contains(e.target) || catBar.contains(e.target);
    if (!isScrollable) e.preventDefault(); 
}, { passive: false });

// --- INFINITE CATEGORY MOVEMENT ---
let autoScroll = true;
function initInfiniteCat() {
    function step() {
        if (autoScroll) {
            catBar.scrollLeft += 1.5;
            if (catBar.scrollLeft >= (catBar.scrollWidth / 3)) {
                catBar.scrollLeft = 0;
            }
        }
        requestAnimationFrame(step);
    }
    requestAnimationFrame(step);

    catBar.addEventListener('touchstart', () => autoScroll = false);
    catBar.addEventListener('touchend', () => setTimeout(() => autoScroll = true, 2000));
    
    catBar.addEventListener('scroll', () => {
        if (catBar.scrollLeft <= 0) catBar.scrollLeft = catBar.scrollWidth / 3;
        if (catBar.scrollLeft >= (catBar.scrollWidth * 2 / 3)) catBar.scrollLeft = catBar.scrollWidth / 3;
    });
}

function initMenu() {
  const container = document.getElementById("mainMenuContainer");
  const categories = [...new Set(menuData.map(i => i.category))];
  const loopCats = [...categories, ...categories, ...categories];

  loopCats.forEach((cat, idx) => {
    const safeName = cat.toLowerCase().replace(/\s+/g, '-');
    const btn = document.createElement("button");
    btn.innerText = cat;
    btn.className = `cat-btn cat-${safeName}`;
    btn.onclick = () => {
      window.scrollTo({ top: document.getElementById(`sec-${safeName}`).offsetTop - 20, behavior: 'smooth' });
      const targetHeader = document.querySelector(`#sec-${safeName} .category-header`);
      targetHeader.classList.remove('header-flash-red');
      void targetHeader.offsetWidth; 
      targetHeader.classList.add('header-flash-red');
    };
    catBar.appendChild(btn);
  });

  categories.forEach(cat => {
    const safeName = cat.toLowerCase().replace(/\s+/g, '-');
    const section = document.createElement("div");
    section.id = `sec-${safeName}`;
    const items = menuData.filter(i => i.category === cat);
    section.innerHTML = `
      <div class="category-header">${cat}</div>
      <div class="menu">
        ${items.map(i => `
          <div class="item">
            <img src="${i.img}">
            <h3>${i.name}</h3><p>â‚¹${i.price}</p>
            <button class="add-btn" onclick="addItem('${i.name}', ${i.price}, this)">âž• ADD</button>
          </div>`).join('')}
      </div>`;
    container.appendChild(section);
  });
  
  initInfiniteCat();
}

window.addItem = (name, price, btn) => {
  if(btn) {
    btn.classList.remove('btn-highlight');
    void btn.offsetWidth; 
    btn.classList.add('btn-highlight');
  }
  if(order[name]) order[name].qty++;
  else order[name] = {name, price, qty:1};
  render();
};

window.removeItem = (name) => {
  order[name].qty--;
  if(order[name].qty <= 0) delete order[name];
  render();
};

function render() {
  const list = document.getElementById("orderList");
  list.innerHTML = ""; total = 0;
  Object.values(order).forEach(o => {
    total += o.price * o.qty;
    list.innerHTML += `<div class="order-item"><span class="order-name">${o.name} Ã— ${o.qty}</span><button class="remove-btn" onclick="removeItem('${o.name}')">âœ–</button></div>`;
  });
  list.scrollTop = list.scrollHeight;
  document.getElementById("totalPrice").innerText = total ? "Total: â‚¹" + total : "";
}

window.submitOrder = async() => {
  const nameInput = document.getElementById("customerName");
  if(!nameInput.value || !Object.keys(order).length) return alert("Enter name and add items!");
  
  const ref = await addDoc(collection(db, "orders"), {
    table, customer: nameInput.value, items: Object.values(order), total, status: "pending", submittedAt: Date.now()
  });
  
  localStorage.setItem(ORDER_KEY, ref.id);
  
  // RESET UI STATE
  localStorage.removeItem(DISMISSED_KEY);
  
  // Start 8-minute Timer
  savePopup("submitted", nameInput.value, total);
  
  listen(ref.id);
  order = {}; render(); nameInput.value = "";
};

function listen(id) {
  onSnapshot(doc(db, "orders", id), async s => {
    if(!s.exists()) return;
    const d = s.data();

    // Mark as actioned in DB if not already
    if((d.status === "accepted" || d.status === "rejected") && !d.actionAt) {
        await updateDoc(doc(db, "orders", id), {actionAt: Date.now()});
    }

    if(d.status === "accepted" || d.status === "rejected") {
      // Logic: Only save new popup (and reset timer) if status changed
      const currentData = JSON.parse(localStorage.getItem(POPUP_KEY) || "{}");
      
      if (currentData.status !== d.status) {
        localStorage.removeItem(DISMISSED_KEY); // New status = show popup regardless of previous dismiss
        savePopup(d.status, d.customer, d.total);
      }
    }
  });
}

function savePopup(status, name, price) {
  // Save with CURRENT timestamp to start/restart timer
  localStorage.setItem(POPUP_KEY, JSON.stringify({status, name, price, start: Date.now()}));
  showPopup();
}

// --- FIX: TIMER LOGIC ---
function checkPopupTimer() {
  const data = localStorage.getItem(POPUP_KEY);
  if(!data) return; // No popup data implies no timer needed
  
  const p = JSON.parse(data);
  const elapsed = Date.now() - p.start;
  const limit = (p.status === "submitted") ? TIME_SUBMITTED : TIME_RESULT;

  // If time is up, close it automatically and clear data
  if (elapsed > limit) {
    document.getElementById("popup").style.display = "none";
    localStorage.removeItem(POPUP_KEY); // Completely remove so it doesn't come back
  }
}

// Run timer check every 1 second
setInterval(checkPopupTimer, 1000);

function showPopup() {
  const data = localStorage.getItem(POPUP_KEY);
  
  // 1. Check if dismissed manually
  if(!data || localStorage.getItem(DISMISSED_KEY) === "true") return;
  
  const p = JSON.parse(data);

  // 2. Check if expired immediately (before showing)
  const elapsed = Date.now() - p.start;
  const limit = (p.status === "submitted") ? TIME_SUBMITTED : TIME_RESULT;
  if(elapsed > limit) {
    localStorage.removeItem(POPUP_KEY);
    return;
  }

  // 3. Render Popup
  const popup = document.getElementById("popup");
  popup.style.display = "flex";
  document.getElementById("closeBtn").style.display = (p.status === "submitted") ? "none" : "block";
  document.getElementById("popupIcon").innerHTML = p.status === "accepted" ? "âœ”" : p.status === "rejected" ? "âœ–" : "â³";
  document.getElementById("popupText").innerText = `${p.name}, order ${p.status.toUpperCase()}`;
  document.getElementById("popupPrice").innerText = p.status !== "rejected" ? "Total: â‚¹" + p.price : "";
}

window.manualClose = () => { 
  document.getElementById("popup").style.display = "none"; 
  localStorage.setItem(DISMISSED_KEY, "true"); 
};

(() => {
  initMenu();
  const id = localStorage.getItem(ORDER_KEY);
  if(id) listen(id);
  showPopup();
})();
</script>
</body>
</html>
