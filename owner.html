<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Paiotorr â€“ Owner Dashboard</title>

<style>
body{
  margin:0;
  padding:20px;
  font-family:Arial, sans-serif;
  background:#ffffff;
}

h1{ margin-bottom:16px; }

/* MAIN LAYOUT */
.main{
  display:grid;
  grid-template-columns: 2fr 1fr;
  gap:16px;
}

/* LEFT */
.pending{
  border:2px solid #f1c40f;
  border-radius:12px;
  padding:14px;
  height:55vh;
  overflow-y:auto;
}

/* RIGHT */
.right{
  display:grid;
  grid-template-rows: 1fr 1fr;
  gap:16px;
  height:55vh;
}

.accepted, .rejected{
  border-radius:12px;
  padding:14px;
  overflow-y:auto;
}

.accepted{ border:2px solid #2ecc71; }
.rejected{ border:2px solid #e74c3c; }

h2{
  margin-top:0;
  position:sticky;
  top:0;
  background:#fff;
  padding-bottom:6px;
}

/* ORDER CARD */
.order{
  border:2px solid #ccc;
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
}

.header{
  display:flex;
  justify-content:space-between;
}

.table{ font-weight:bold; }
.time{ font-size:13px; color:#555; }

.customer{
  font-weight:bold;
  margin:6px 0;
}

/* ITEM */
.item{
  display:flex;
  align-items:center;
  margin-bottom:8px;
}

.item img{
  width:70px;
  height:70px;
  border-radius:10px;
  margin-right:10px;
  object-fit:cover;
  border:1px solid #ccc;
}

.itemText{ font-weight:bold; }

.total{ font-weight:bold; margin-top:6px; }

/* ACTIONS */
.actions button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.acceptBtn{ background:#2ecc71;color:#fff; }
.rejectBtn{ background:#e74c3c;color:#fff; }

/* STATUS */
.status{
  font-size:18px;
  font-weight:bold;
  margin-top:6px;
}
.ok{ color:#2ecc71; }
.no{ color:#e74c3c; }

/* DATE FILTER */
.analytics{
  margin-top:30px;
  padding:20px;
  border-top:3px solid #000;
}

.filter{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}

.filter input{
  padding:10px;
  font-size:16px;
}

.filter button{
  padding:10px 18px;
  border:2px solid #000;
  background:#000;
  color:#fff;
  font-weight:bold;
}

.activeBtn{
  background:#fff!important;
  color:#000!important;
}
</style>
</head>

<body>

<h1>ðŸ“‹ Paiotorr â€“ Owner</h1>

<div class="main">

  <div class="pending">
    <h2>ðŸŸ¡ Pending Orders</h2>
    <div id="pending"></div>
  </div>

  <div class="right">
    <div class="accepted">
      <h2>ðŸŸ¢ Accepted</h2>
      <div id="accepted"></div>
    </div>
    <div class="rejected">
      <h2>ðŸ”´ Rejected</h2>
      <div id="rejected"></div>
    </div>
  </div>

</div>

<div class="analytics">
  <h2>ðŸ“… Filter</h2>
  <div class="filter">
    <input type="date" id="fromDate">
    <input type="date" id="toDate">
    <button id="applyBtn" onclick="applyFilter()">Apply</button>
    <button id="clearBtn" onclick="clearFilter()">Clear</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
  apiKey:"AIzaSyDSf51jWs3I4AXX0U8M_HxKn4VtRYg72xs",
  authDomain:"hotel-order-7f1f2.firebaseapp.com",
  projectId:"hotel-order-7f1f2"
});
const db = getFirestore(app);

const pendingDiv = document.getElementById("pending");
const acceptedDiv = document.getElementById("accepted");
const rejectedDiv = document.getElementById("rejected");

const DEFAULT_IMG =
  "https://raw.githubusercontent.com/paiotorr/Paiotorr/main/image/Pizza.jpg";

/* ðŸ”” TEMPLE BELL (AUTO-UNLOCK) */
let audioCtx = null;
let audioReady = false;

document.addEventListener("pointerdown", () => {
  if(!audioReady){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioReady = true;
  }
}, { once:true });

function ringBell(){
  if(!audioReady) return;

  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();

  o.type = "sine";
  o.frequency.setValueAtTime(880, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.6);

  g.gain.setValueAtTime(0.001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.5, audioCtx.currentTime + 0.02);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.2);

  o.connect(g);
  g.connect(audioCtx.destination);

  o.start();
  o.stop(audioCtx.currentTime + 1.2);
}

/* DATA */
let allOrders = [];
let lastPending = 0;

/* LIVE ORDERS */
onSnapshot(collection(db,"orders"), snap=>{
  allOrders=[];
  let pendingCount=0;

  snap.forEach(d=>{
    const o={id:d.id,...d.data()};
    allOrders.push(o);
    if(o.status==="pending") pendingCount++;
  });

  if(pendingCount > lastPending){
    ringBell();
  }

  lastPending = pendingCount;
  render(allOrders);
});

/* FILTER */
window.applyFilter = ()=>{
  applyBtn.classList.add("activeBtn");
  clearBtn.classList.remove("activeBtn");

  if(!fromDate.value || !toDate.value) return;

  const f=new Date(fromDate.value);
  const t=new Date(toDate.value);
  t.setHours(23,59,59);

  render(allOrders.filter(o=>{
    if(o.status==="pending") return true;
    return new Date(o.time)>=f && new Date(o.time)<=t;
  }));
};

window.clearFilter = ()=>{
  clearBtn.classList.add("activeBtn");
  applyBtn.classList.remove("activeBtn");
  fromDate.value="";
  toDate.value="";
  render(allOrders);
};

/* RENDER */
function render(list){
  pendingDiv.innerHTML="";
  acceptedDiv.innerHTML="";
  rejectedDiv.innerHTML="";

  list.forEach(o=>{
    let itemsHTML="";
    o.items.forEach(i=>{
      itemsHTML+=`
        <div class="item">
          <img src="${i.img || DEFAULT_IMG}">
          <div class="itemText">${i.name} Ã— ${i.qty}</div>
        </div>`;
    });

    const card=`
      <div class="order">
        <div class="header">
          <div class="table">Table ${o.table}</div>
          <div class="time">${o.time}</div>
        </div>
        <div class="customer">ðŸ‘¤ ${o.customer}</div>
        ${itemsHTML}
        <div class="total">â‚¹${o.total}</div>
        ${
          o.status==="pending"
          ? `<div class="actions">
               <button class="acceptBtn" onclick="setStatus('${o.id}','accepted')">Accept</button>
               <button class="rejectBtn" onclick="setStatus('${o.id}','rejected')">Reject</button>
             </div>`
          : `<div class="status ${o.status==="accepted"?"ok":"no"}">
               ${o.status==="accepted"?"âœ” ACCEPTED":"âœ– REJECTED"}
             </div>`
        }
      </div>
    `;

    if(o.status==="pending") pendingDiv.innerHTML+=card;
    if(o.status==="accepted") acceptedDiv.innerHTML+=card;
    if(o.status==="rejected") rejectedDiv.innerHTML+=card;
  });
}

/* STATUS */
window.setStatus = async(id,status)=>{
  await updateDoc(doc(db,"orders",id),{status});
};
</script>

</body>
</html>